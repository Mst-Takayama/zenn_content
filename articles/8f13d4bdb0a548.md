---
title: "è¤‡æ•°å›ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒå¿…è¦ãªOIDCèªè¨¼ãƒ•ãƒ­ãƒ¼ã«ãŠã‘ã‚‹çŠ¶æ…‹ç®¡ç†ã®å®Ÿè£…"
emoji: "ğŸ”„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["OAuth", "OIDC", "èªè¨¼", "Redis", "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"]
published: true
---

# ã¯ã˜ã‚ã«

ä»¥å‰,ã¨ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æºæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸ.
ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æºã§ã¯,OIDCãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ãŸSSOãƒ­ã‚°ã‚¤ãƒ³ã‚„IDé€£æºã‚’è¡Œã„ã¾ã™.
ã“ã®è¨˜äº‹ã§ã¯,ç‰¹ã«OIDCã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã«ãŠã‘ã‚‹è¤‡æ•°å›ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†ã¨,ãã®é–“ã®çŠ¶æ…‹ç®¡ç†ã«ã¤ã„ã¦è€ƒãˆãŸã“ã¨ã‚’ã¾ã¨ã‚ã¾ã™.

# é€£æºã®æ¦‚è¦

ã“ã®SSOã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æºã§ã¯,ä»¥ä¸‹ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸ:

- SSOã«ã‚ˆã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²
- SSOã«ã‚ˆã‚‹ãƒ­ã‚°ã‚¤ãƒ³
- æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨SSOã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç´ã¥ã‘

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã‚Š,OIDCã®èªå¯ã‚³ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™.

# èª²é¡Œ: è¤‡æ•°å›ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã¨çŠ¶æ…‹ç®¡ç†

OIDCã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ä¸­ã§,ç‰¹ã«èª²é¡Œã¨ãªã£ãŸã®ãŒ**ã‚ªãƒ—ãƒˆã‚¤ãƒ³åˆ¤å®šã¨ã‚ªãƒ—ãƒˆã‚¤ãƒ³ç”»é¢ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**ã§ã™.

é€šå¸¸ã®OIDCãƒ•ãƒ­ãƒ¼ã§ã¯:

1. èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
2. èªè¨¼å¾Œ,æŒ‡å®šã—ãŸãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã¸ã®æˆ»ã‚Š

ã¨ã„ã†æµã‚Œã«ãªã‚Šã¾ã™ãŒ,ä»Šå›é€£æºã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã§ã¯:

1. èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
2. èªè¨¼å¾Œ,ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
3. ã‚ªãƒ—ãƒˆã‚¤ãƒ³åˆ¤å®šAPIã®å‘¼ã³å‡ºã—
4. ã‚ªãƒ—ãƒˆã‚¤ãƒ³æœªåŒæ„ã®å ´åˆ,ã‚ªãƒ—ãƒˆã‚¤ãƒ³ç”»é¢ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
5. ã‚ªãƒ—ãƒˆã‚¤ãƒ³åŒæ„å¾Œ,å†åº¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

ã¨ã„ã†,**2åº¦ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**ãŒç™ºç”Ÿã—ã¾ã™.

ã“ã“ã§å•é¡Œã¨ãªã‚‹ã®ãŒ,**1åº¦ç›®ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§å–å¾—ã—ãŸæƒ…å ±ã‚’,2åº¦ç›®ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã«ã©ã†å–å¾—ã™ã‚‹ã‹**ã¨ã„ã†ç‚¹ã§ã™.

# è§£æ±ºç­–: stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨Redisã‚’ä½¿ã£ãŸçŠ¶æ…‹ç®¡ç†

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«,ä»¥ä¸‹ã®æ–¹æ³•ã‚’æ¡ç”¨ã—ã¾ã—ãŸ:

1. **stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«UUIDã‚’å«ã‚ã‚‹**
2. **UUIDã‚’ã‚­ãƒ¼ã¨ã—ã¦Redisã«æƒ…å ±ã‚’ä¿å­˜**

### stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­è¨ˆ

OIDCã®stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯,CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦ã®å½¹å‰²ã‚’æŒã¡ã¾ã™ãŒ,ã“ã‚Œã‚’æ‹¡å¼µã—ã¦çŠ¶æ…‹ç®¡ç†ã«ã‚‚åˆ©ç”¨ã—ã¾ã™.

å½“åˆã¯å˜ç´”ãªãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ã‚’stateã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã¾ã—ãŸãŒ,ãƒ­ã‚°ã‚¤ãƒ³ã¨æ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºã®åŒºåˆ¥ãŒã§ããªã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸ.ãã“ã§,`{type}:{uuid}`ã®å½¢å¼ã‚’æ¡ç”¨ã—,å‡¦ç†ã®åˆ†å²ã‚’æ˜ç¢ºã«ã—ã¾ã—ãŸ.

```
state = "{type}:{uuid}"
```

- `type`: ãƒ­ã‚°ã‚¤ãƒ³ã‹é€£æºã‹ã‚’ç¤ºã™è­˜åˆ¥å­ (ä¾‹: "login", "link")
- `uuid`: ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆã—ãŸUUID

ä¾‹: `login:550e8400-e29b-41d4-a716-446655440000`

### Redisã‚’ä½¿ã£ãŸçŠ¶æ…‹ä¿æŒ

stateã«å«ã¾ã‚Œã‚‹UUIDã‚’ã‚­ãƒ¼ã¨ã—ã¦,Redisã«ä»¥ä¸‹ã®æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™:

```
{
  "access_token": "eyJhbGciOiJSUzI1...",
  "id_token": "eyJhbGciOiJSUzI1...",
  "refresh_token": "eyJhbGciOiJSUzI1..."
}
```

TTL(Time To Live)ã‚’è¨­å®šã—,ä¸€å®šæ™‚é–“å¾Œã«è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™.

## å®Ÿè£…ãƒ•ãƒ­ãƒ¼

### 1. èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```mermaid
sequenceDiagram
  participant App as ã‚¢ãƒ—ãƒª
  participant BE as ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
  participant Auth as èªå¯ã‚µãƒ¼ãƒãƒ¼
  
  App->>BE: SSOãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ (GET /sso_providers/:id/url)
  BE-->>App: èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®URLã‚’æä¾›
  App->>Auth: èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  Note over App: code_verifierã€nonceã€code_challengeã€stateã‚’ç”Ÿæˆ
```

ã“ã®æ™‚ç‚¹ã§,stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«`{type}:{uuid}`ã®å½¢å¼ã§UUIDã‚’å«ã‚ã¾ã™.

### 2. èªè¨¼å¾Œã®1åº¦ç›®ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†

```mermaid
sequenceDiagram
  participant App as ã‚¢ãƒ—ãƒª
  participant BE as ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
  participant Auth as èªå¯ã‚µãƒ¼ãƒãƒ¼
  participant Redis as Redis
  
  Auth-->>App: èªå¯ã‚³ãƒ¼ãƒ‰ã¨stateã‚’å«ã‚€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  App->>BE: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã«APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ (POST /sso_providers/:id/auth/)
  Note over App: codeã€code_verifierã€nonceã€stateã‚’å«ã‚ã‚‹
  BE->>Auth: ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  Auth-->>BE: ID,ã‚¢ã‚¯ã‚»ã‚¹,ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™
  BE->>BE: IDãƒˆãƒ¼ã‚¯ãƒ³/ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
  BE->>Auth: ã‚ªãƒ—ãƒˆã‚¤ãƒ³åˆ¤å®šAPIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  Auth-->>BE: agree_flag(ã‚ªãƒ—ãƒˆã‚¤ãƒ³ãƒ•ãƒ©ã‚°)ã‚’è¿”ã™
```

ã‚ªãƒ—ãƒˆã‚¤ãƒ³åˆ¤å®šã®çµæœ,æœªåŒæ„ã®å ´åˆã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã¿ã¾ã™.

### 3. ã‚ªãƒ—ãƒˆã‚¤ãƒ³æœªåŒæ„æ™‚ã®å‡¦ç†ã¨Redisã¸ã®ä¿å­˜

```mermaid
sequenceDiagram
  participant App as ã‚¢ãƒ—ãƒª
  participant BE as ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
  participant Auth as èªå¯ã‚µãƒ¼ãƒãƒ¼
  participant Redis as Redis
  
  BE->>Redis: stateã®UUIDã‚’ã‚­ãƒ¼ã«ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’ä¿å­˜ (TTLè¨­å®š)
  BE-->>App: ã‚ªãƒ—ãƒˆã‚¤ãƒ³ç”»é¢ã®URLã‚’æä¾›
  App->>Auth: ã‚ªãƒ—ãƒˆã‚¤ãƒ³ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹
```

ã“ã®æ™‚ç‚¹ã§,stateã«å«ã¾ã‚Œã‚‹UUIDã‚’ã‚­ãƒ¼ã¨ã—ã¦,ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’Redisã«ä¿å­˜ã—ã¾ã™.

### 4. ã‚ªãƒ—ãƒˆã‚¤ãƒ³åŒæ„å¾Œã®2åº¦ç›®ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†

```mermaid
sequenceDiagram
  participant App as ã‚¢ãƒ—ãƒª
  participant BE as ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
  participant Auth as èªå¯ã‚µãƒ¼ãƒãƒ¼
  participant Redis as Redis
  
  Auth-->>App: ã‚ªãƒ—ãƒˆã‚¤ãƒ³å¾Œ,ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  App->>BE: ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã«APIã‚’å©ã (GET /sso_providers/:id/users/retrieve)
  Note over App: stateã®å€¤ã‚’åˆ©ç”¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  BE->>Redis: stateã®UUIDã‚’å…ƒã«ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’å–å¾—
  Redis-->>BE: ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’è¿”ã™
  BE->>Auth: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  Auth-->>BE: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™
```

2åº¦ç›®ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œ,stateã«å«ã¾ã‚Œã‚‹UUIDã‚’ä½¿ã£ã¦Redisã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’å–å¾—ã—,ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—APIã‚’å‘¼ã³å‡ºã—ã¾ã™.

## å®Ÿè£…ä¾‹

ã“ã‚Œã¯è¨­è¨ˆæ€æƒ³ã‚’AIã«é£Ÿã‚ã›ãŸã‚‰åã„ãŸã‚‚ã®ã§ã™.

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã®å®Ÿè£…

#### 1. stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç”Ÿæˆã¨æ¤œè¨¼

```ruby
# èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®URLã‚’ç”Ÿæˆã™ã‚‹éš›ã®stateç”Ÿæˆ
def generate_state(type)
  uuid = SecureRandom.uuid
  state = "#{type}:#{uuid}"
  state
end

# ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ™‚ã®stateæ¤œè¨¼
def validate_state(state)
  return false if state.blank?
  
  # stateã®å½¢å¼ã‚’æ¤œè¨¼
  parts = state.split(':')
  return false unless parts.length == 2
  
  type = parts[0]
  uuid = parts[1]
  
  # typeãŒæœ‰åŠ¹ã‹æ¤œè¨¼
  valid_types = ['login', 'link']
  return false unless valid_types.include?(type)
  
  # UUIDã®å½¢å¼ã‚’æ¤œè¨¼
  uuid_regex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/
  return false unless uuid.match?(uuid_regex)
  
  true
end
```

#### 2. Redisã¸ã®æƒ…å ±ä¿å­˜

```ruby
# ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’Redisã«ä¿å­˜
def store_tokens_in_redis(state, tokens)
  parts = state.split(':')
  uuid = parts[1]
  
  # ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’JSONã¨ã—ã¦ä¿å­˜
  token_data = {
    access_token: tokens[:access_token],
    id_token: tokens[:id_token],
    refresh_token: tokens[:refresh_token]
  }.to_json
  
  # TTLã‚’5åˆ†ã«è¨­å®š
  REDIS.setex("sso:tokens:#{uuid}", 5 * 60, token_data)
end

# Redisã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’å–å¾—
def retrieve_tokens_from_redis(state)
  parts = state.split(':')
  uuid = parts[1]
  
  token_data = REDIS.get("sso:tokens:#{uuid}")
  return nil if token_data.nil?
  
  # JSONã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã«å¤‰æ›
  JSON.parse(token_data).symbolize_keys
end
```

#### 3. ã‚ªãƒ—ãƒˆã‚¤ãƒ³åˆ¤å®šã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†

```ruby
def handle_auth_callback(code, state, code_verifier, nonce)
  # stateã®æ¤œè¨¼
  unless validate_state(state)
    return { error: 'Invalid state parameter' }
  end
  
  # ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  tokens = fetch_tokens(code, code_verifier)
  
  # IDãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼
  unless verify_id_token(tokens[:id_token], nonce)
    return { error: 'Invalid ID token' }
  end
  
  # ã‚ªãƒ—ãƒˆã‚¤ãƒ³åˆ¤å®šAPIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  optin_status = check_optin_status(tokens[:access_token])
  
  if optin_status[:agree_flag] == 0
    # ã‚ªãƒ—ãƒˆã‚¤ãƒ³æœªåŒæ„ã®å ´åˆ
    # ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’Redisã«ä¿å­˜
    store_tokens_in_redis(state, tokens)
    
    # ã‚ªãƒ—ãƒˆã‚¤ãƒ³ç”»é¢ã®URLã‚’ç”Ÿæˆ
    optin_url = generate_optin_url(state)
    
    return { redirect_to: optin_url }
  else
    # ã‚ªãƒ—ãƒˆã‚¤ãƒ³åŒæ„æ¸ˆã¿ã®å ´åˆ
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    user_info = fetch_user_info(tokens[:access_token])
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å…ƒã«å‡¦ç†
    process_user_info(user_info, state)
  end
end
```

#### 4. ã‚ªãƒ—ãƒˆã‚¤ãƒ³å¾Œã®å‡¦ç†

```ruby
def handle_optin_callback(state)
  # stateã®æ¤œè¨¼
  unless validate_state(state)
    return { error: 'Invalid state parameter' }
  end
  
  # Redisã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’å–å¾—
  tokens = retrieve_tokens_from_redis(state)
  
  if tokens.nil?
    return { error: 'Session expired' }
  end
  
  # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  user_info = fetch_user_info(tokens[:access_token])
  
  # ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å…ƒã«å‡¦ç†
  process_user_info(user_info, state)
end
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®å®Ÿè£…

#### 1. èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```javascript
// SSOãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
async function handleSSOButtonClick() {
  try {
    // èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®URLã‚’å–å¾—
    const response = await fetch('/sso_providers/1/url?type=login');
    const data = await response.json();
    
    if (data.url) {
      // code_verifierã¨nonceã‚’ç”Ÿæˆã—ã¦ä¿å­˜
      const codeVerifier = generateCodeVerifier();
      const nonce = generateNonce();
      localStorage.setItem('code_verifier', codeVerifier);
      localStorage.setItem('nonce', nonce);
      
      // code_challengeã‚’ç”Ÿæˆ
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      
      // èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ã®URLã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
      const url = new URL(data.url);
      url.searchParams.append('code_challenge', codeChallenge);
      url.searchParams.append('code_challenge_method', 'S256');
      url.searchParams.append('nonce', nonce);
      
      // èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      window.location.href = url.toString();
    }
  } catch (error) {
    console.error('Error fetching authorization URL:', error);
  }
}

// code_verifierã®ç”Ÿæˆ
function generateCodeVerifier() {
  const array = new Uint8Array(32);
  window.crypto.getRandomValues(array);
  return base64UrlEncode(array);
}

// nonceã®ç”Ÿæˆ
function generateNonce() {
  const array = new Uint8Array(16);
  window.crypto.getRandomValues(array);
  return base64UrlEncode(array);
}

// code_challengeã®ç”Ÿæˆ
async function generateCodeChallenge(codeVerifier) {
  const encoder = new TextEncoder();
  const data = encoder.encode(codeVerifier);
  const digest = await window.crypto.subtle.digest('SHA-256', data);
  return base64UrlEncode(new Uint8Array(digest));
}

// Base64 URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
function base64UrlEncode(array) {
  return btoa(String.fromCharCode.apply(null, array))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}
```

#### 2. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã®å‡¦ç†

```javascript
// èªå¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
async function handleAuthCallback() {
  // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  const state = urlParams.get('state');
  
  if (!code || !state) {
    console.error('Missing code or state parameter');
    return;
  }
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰code_verifierã¨nonceã‚’å–å¾—
  const codeVerifier = localStorage.getItem('code_verifier');
  const nonce = localStorage.getItem('nonce');
  
  try {
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    const response = await fetch('/sso_providers/1/auth', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-App-Type': 'web'
      },
      body: JSON.stringify({
        code,
        state,
        code_verifier: codeVerifier,
        nonce
      })
    });
    
    const data = await response.json();
    
    if (data.redirect_to) {
      // ã‚ªãƒ—ãƒˆã‚¤ãƒ³ç”»é¢ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒå¿…è¦ãªå ´åˆ
      window.location.href = data.redirect_to;
    } else if (data.authentication_token) {
      // èªè¨¼æˆåŠŸã®å ´åˆ
      localStorage.setItem('auth_token', data.authentication_token);
      navigateToHome();
    } else if (data.error) {
      // ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
      showError(data.error);
    }
  } catch (error) {
    console.error('Error during authentication:', error);
  } finally {
    // ä½¿ç”¨æ¸ˆã¿ã®code_verifierã¨nonceã‚’å‰Šé™¤
    localStorage.removeItem('code_verifier');
    localStorage.removeItem('nonce');
  }
}

// ã‚ªãƒ—ãƒˆã‚¤ãƒ³ç”»é¢ã‹ã‚‰ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
async function handleOptinCallback() {
  // URLã‹ã‚‰stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
  const urlParams = new URLSearchParams(window.location.search);
  const state = urlParams.get('state');
  
  if (!state) {
    console.error('Missing state parameter');
    return;
  }
  
  try {
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    const response = await fetch(`/sso_providers/1/users/retrieve?state=${state}`);
    const data = await response.json();
    
    if (data.authentication_token) {
      // èªè¨¼æˆåŠŸã®å ´åˆ
      localStorage.setItem('auth_token', data.authentication_token);
      navigateToHome();
    } else if (data.sso_id) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãŒå¿…è¦ãªå ´åˆ
      navigateToRegistration(data.sso_id, data.provider_id);
    } else if (data.error) {
      // ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
      showError(data.error);
    }
  } catch (error) {
    console.error('Error retrieving user info:', error);
  }
}
```

## å®Ÿè£…ä¸Šã®å·¥å¤«

### 1. ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®å¼·åŒ–

å®Ÿéš›ã®å®Ÿè£…ã§ã¯,ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’è€ƒæ…®ã—ã¾ã—ãŸ:

- Redisã¸ã®ä¿å­˜/å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆ
- ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚ŒãŸå ´åˆ
- ã‚ªãƒ—ãƒˆã‚¤ãƒ³ç”»é¢ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸå ´åˆ

ã“ã‚Œã‚‰ã®ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œã™ã‚‹ãŸã‚,ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é©åˆ‡ã«è¡¨ç¤ºã—,å¿…è¦ã«å¿œã˜ã¦èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™.

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã™ã‚‹ãŸã‚ã«,ä»¥ä¸‹ã®å¯¾ç­–ã‚’å®Ÿè£…ã—ã¾ã—ãŸ:

- stateãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å³æ ¼ãªæ¤œè¨¼
- IDãƒˆãƒ¼ã‚¯ãƒ³ã®ç½²åæ¤œè¨¼ã¨æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
- Redisã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–
- CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®ä½¿ç”¨

# ä»Šå¾Œã®æ”¹å–„ç‚¹

**ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®æ´»ç”¨**: ç¾åœ¨ã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚ŒãŸå ´åˆ,èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’ã‚„ã‚Šç›´ã—ã¦ã„ã¾ã™ãŒ, å®Œå…¨ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®å­˜åœ¨ã‚’å¿˜ã‚Œã¦ã„ã¾ã—ãŸ