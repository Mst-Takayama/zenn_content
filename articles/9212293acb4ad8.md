---
title: "kamalã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®healthcheké–“éš”ã‚’ä¼¸ã°ã—ãŸã„"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby","rails","kamal"]
published: true
---

# çµè«–
`deploy.yml`ã«`interval`ã‚’è¿½åŠ ã—ã¾ã™
æœ€å¤§ã®intervalã¯20sã§ã™
```
# Configure a custom healthcheck (default is /up on port 3000)
healthcheck:
  interval: 20s
```

# è›‡è¶³
ä»¥å‰,ã“ã‚“ãªè¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸãŒ
https://zenn.dev/onikukirai/articles/9f5c07278a5a14

```ruby
kamal app logs
```
ã§ãƒ­ã‚°ã‚’è¦—ã„ã¦ã¿ã‚‹ã¨,1ç§’æ¯ã«localhostã‹ã‚‰healthcheckãŒè¡Œã‚ã‚Œã¦ã„ã¾ã—ãŸ

ã‚¤ãƒ¡ãƒ¼ã‚¸
```log
 Started GET "/up" for 127.0.0.1 at 2023-10-14 17:45:21 +0000
I, [2023-10-10T17:45:21.563789 #1]  INFO -- : [64d8742d-895c-43cc-9b71-6b7bb543a7a6] Processing by HealthController#up as */*
 Started GET "/up" for 127.0.0.1 at 2023-10-14 17:46:21 +0000
I, [2023-10-10T17:45:21.563789 #1]  INFO -- : [64d8742d-895c-43cc-9b71-6b7bb543a7a6] Processing by HealthController#up as */*
 Started GET "/up" for 127.0.0.1 at 2023-10-14 17:47:21 +0000
I, [2023-10-10T17:45:21.563789 #1]  INFO -- : [64d8742d-895c-43cc-9b71-6b7bb543a7a6] Processing by HealthController#up as */*
 Started GET "/up" for 127.0.0.1 at 2023-10-14 17:48:21 +0000
I, [2023-10-10T17:45:21.563789 #1]  INFO -- : [64d8742d-895c-43cc-9b71-6b7bb543a7a6] Processing by HealthController#up as */*
 Started GET "/up" for 127.0.0.1 at 2023-10-14 17:49:21 +0000
I, [2023-10-10T17:45:21.563789 #1]  INFO -- : [64d8742d-895c-43cc-9b71-6b7bb543a7a6] Processing by HealthController#up as */*

```
ãã‚“ãªè¦ä»¶ã‚’æ±‚ã‚ã¦ãªã„å ´åˆ,ã“ã“ã¾ã§ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯éå‰°ã˜ã‚ƒãªã„ã§ã—ã‚‡ã†ã‹
ã¾ãŸ,AWS cloudwatchã«ãƒ­ã‚°ã‚’æµã—ã¦ã„ã‚‹å ´åˆæ–™é‡‘ã‚‚ã‚ãŒã‚Šãã†ã§ã™
é‚ªé­”ãã•ã„ã®ã§ã“ã®é–“éš”ã‚’ä¼¸ã°ã›ãªã„ã‹ã¨è©¦ã—ã¦ã¿ã¾ã—ãŸ


## docker inspectã§ã‚³ãƒ³ãƒ†ãƒŠã®æƒ…å ±ã‚’æ‹¾ã£ã¦ã¿ã‚‹
```yaml
  "Healthcheck": {
                "Test": [
                    "CMD-SHELL",
                    "(curl -f http://localhost:3000/up || exit 1) && (stat /tmp/kamal-cord/cord > /dev/null || exit 1)"
                ],
                "Interval": 1000000000
            },
```
"Interval" : 1000000000
ãªã«ã‚„ã‚‰ãã‚Œã£ã½ã„ã‚‚ã®ã‚’ã¿ã¤ã‘ã¾ã—ãŸ
Dockerfileã«
```
# Dockerfile
HEALTHCHECK NONE
```
ã‚’è¿½åŠ ã—ã¦ã¿ãŸã‚Šã—ã¾ã—ãŸãŒåŠ¹æœãŒã‚ã‚Šã¾ã›ã‚“


## kamal setupã§ã®ãƒ­ã‚°ã‚’ã‚ˆãè¦‹ã¦ã¿ã‚‹

```log
# å¿…è¦ãªéƒ¨åˆ†ã ã‘æŠœç²‹
Ensure app can pass healthcheck...

INFO [02be2305] Running docker run --health-cmd "curl -f http://localhost:3000/up || exit 1" --health-interval "1s" 
```

`docker run --health-interval "1s"` ã—ã¦ã„ã‚‹!

`deploy.yml`ã®ã“ã“ã§intervalã‚’è¨­å®šã—ã¦ã„ãªã„ã¨1sã«ãªã‚‹ã‚ˆã†ã 

```yml
# deploy.yml
healthcheck:
  path: /healthz
  port: 4000
  max_attempts: 7
  interval: 20s
```

docker runã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã‚‹ã¨
`--health-interval`ã«ã¯ms,s,m,hã‚’æŒ‡å®šã§ãã‚‹ã¨æ›¸ã„ã¦ã‚ã‚Š
1æ™‚é–“ã«ã—ã‚ˆã†ã¨ã—ãŸã®ã ãŒ


```yml
healthcheck:
  interval: 1h
```


```log
Releasing the deploy lock...
  Finished all in 54.2 seconds
  ERROR (Kamal::Cli::Healthcheck::Poller::HealthcheckError): Exception while executing on host 13.230.17.150: container not ready (starting)
```
  healthcheckã®çµæœã‚’ã¾ã£ã¦ã„ã‚‹ã®ã§intervalã‚’é•·ãã—ã™ãã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ãŸã¨ã¿ãªã•ã‚Œã¦ã—ã¾ã†ã¿ãŸã„..?

  è©¦ã—ã¦ã¿ãŸã¨ã“ã‚20sãŒæœ€å¤§ã§ã—ãŸ