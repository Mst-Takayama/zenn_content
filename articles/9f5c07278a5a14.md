---
title: "kamalã§Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’EC2ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby","rails","aws","kamal","docker"]
published: false
---

kamalã¯, Ruby on Railsã®ä½œè€…ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹,
David Heinemeier Hasson (DHH)æ°ã«ã‚ˆã£ã¦ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ
WEB ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã§ã™.

ã‚ã‚“ã©ãã•ã„ãƒ‡ãƒ—ãƒ­ã‚¤ä½œæ¥­ã‚’ç°¡å˜ã«ã‚„ã£ã¦ãã‚Œãã†ãªã®ã§
æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®Rails7.1ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ã¤ã„ã§ã«è§¦ã£ã¦ã¿ã¾ã—ãŸ.
å¾©ç¿’å…¼,å‚™å¿˜éŒ²ã¨ã—ã¦æŠ•ç¨¿ã—ã¦ã„ã¾ã™.
https://kamal-deploy.org/

# å®Œæˆå›³
ä¸‹è¨˜ã®æ§‹æˆå›³ã®ã‚ˆã†ãªç’°å¢ƒã‚’ä½œæˆã—, 
EC2ã¸Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™.
```mermaid
graph TD
    style AWSCloud fill:none,color:#345,stroke:#345;
    style Region fill:none,color:#59d,stroke:#59d,stroke-dasharray:3;
    style VPC fill:none,color:#0a0,stroke:#0a0;
    style PublicSubnet fill:#E8F2F9,color:#07b,stroke:none;
    style PrivateSubnet fill:#E7F2E8,color:#092,stroke:none;
    style Route53 fill:#84d,color:#fff,stroke:none;
    style ALB fill:#84d,color:#fff,stroke:none;
    style EC2 fill:#e83,color:#fff,stroke:none;
    style RDS fill:#46d,color:#fff,stroke:#fff;
    style User fill:#aaa,color:#fff,stroke:#fff;

    subgraph AWSCloud[AWS Cloud]
        subgraph Region[AWS Region]
            ALB[ALB]
            subgraph VPC[VPC]
                subgraph PublicSubnet[Public Subnet]
                    EC2[EC2]
                end
                subgraph PrivateSubnet[Private Subnet]
                    RDS[RDS]
                end
            end
        end
    end

    User[User] --> Route53[Route53]
    Route53 --> ALB
    ALB --> EC2
    EC2 --> RDS
```

# AWSç’°å¢ƒã®æ§‹ç¯‰
ä»Šå›ã¯ubuntuã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦EC2ã‚’ä½œæˆã—,Postgresqlã®RDSã‚’DBã¨ã—ã¦åˆ©ç”¨ã—ã¾ã™.
ã“ã“ã‚‰ã¸ã‚“ã¯ã‚µãƒ©ãƒƒã¨æµã—ã¾ã™
- **VPCä½œæˆ**
- **EC2ä½œæˆ**
ä½œæˆå¾ŒElasticIPã§IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å›ºå®šã«ã—ã¾ã™.
IPã‚’å›ºå®šã«ã™ã‚‹ç†ç”±ã¯, kamalhaIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ãŸã‚,
IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ç¢ºèªã™ã‚‹ã®ãŒæ‰‹é–“ã ã‹ã‚‰ã§ã™.
- **RDSä½œæˆ**
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«EC2ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ 
- **ALBä½œæˆ**
ALBã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’EC2ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
- **Route53ä½œæˆ**
# Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ
```zsh
$ rails -v
Rails 7.1.0
```
```ruby
rails new my_app --api
```
ä»Šå›ã¯Rails7.1ã®apiãƒ¢ãƒ¼ãƒ‰ã§ä¸‹å›³ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ.
Rails7.1ã§ `rails new` ã™ã‚‹ã¨,æœ€åˆã‹ã‚‰ `Dockerfile` ã‚„ `bin/docker-entrypoint` , `.dockerignore` ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™.å¬‰ã—ã„ã§ã™ã­.

https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/app/templates/Dockerfile.tt

# kamalã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤
## kamalã®å°å…¥

**Gemfile** ã«kamalã‚’è¨˜è¿°ã—,installã—ã¾ã™.
```ruby
# Gemfile
gem 'kamal', '~> 1.0.0'
```

```
$ bundle install
```

`kamal init` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ `config/deploy.yml`ãŒç”Ÿæˆã•ã‚Œã¾ã™.
`config/deploy.yml`ã«ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’è¨˜è¿°ã—ã¦ã„ãã¾ã™.
```zsh
$ kamal init
Created configuration file in config/deploy.yml
Created .env file
Created sample hooks in .kamal/hooks
```
`config/deploy.yml`ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã«ãªã‚Šã¾ã™.

## EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®SSHæ¥ç¶šæº–å‚™
kamalãŒsshæ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ssh agentã«EC2ã®pemã‚’è¿½åŠ ã—ã¾ã™
```
ssh-add /path/to/your-key.pem
```

## EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«dockerã¨curlã®install
```
sudo apt update
sudo apt upgrade -y
sudo apt install -y docker.io curl git
```

EC2ã§ã¯ä½œæˆæ™‚ubuntuã¨ã„ã†ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã¾ã™
ubuntuãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒsudoã‚’ä½¿ã‚ãšã«Dockerã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™
```
sudo usermod -a -G docker ubuntu
```

## .envãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†
kamalã¯`dotenv`ã‚’ä½¿ç”¨ã—ã¦,ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒˆã«å­˜åœ¨ã™ã‚‹`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã•ã‚ŒãŸç’°å¢ƒå¤‰æ•°ã‚’è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¿ã¾ã™.
.envãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¨˜è¿°ã—ã¾ã™
- **KAMAL_REGISTRY_PASSWORD**
docker imageã‚’pushã™ã‚‹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
docker hubã®å ´åˆtokenã®åˆ©ç”¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹
- **RAILS_MASTER_KEY**
master.keyã®å†…å®¹
- **DB_URL**
RDSã¸ã®æ¥ç¶šæƒ…å ±

```ruby
KAMAL_REGISTRY_PASSWORD=change-this
RAILS_MASTER_KEY=master.keyã®å€¤ã‚’å…¥åŠ›
DATABASE_URL="postgres://myuser:mypass@localhost/somedatabase"
```

## database.ymlã®ç·¨é›†
ä»Šå›ã¯productionç’°å¢ƒã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã§,
productionç’°å¢ƒã§å…ˆç¨‹ã¤ãã£ãŸRDSã«æ¥ç¶šã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™.

```ruby
production:
  <<: *default
  url: <%= ENV['DATABASE_URL'] %>
```

## deploy.ymlã®ç·¨é›†
ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨deploy.ymlã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã¿ã‚Œã°åˆ†ã‹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™

- service
ä»»æ„ã®åå‰ã‚’å…¥åŠ›ã—ã¾ã™
- image
ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ¡ãƒ¼ã‚¸åã‚’å…¥åŠ›ã—ã¾ã™
- servers
EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¾ã™
```ruby
# Name of your application. Used to uniquely configure containers.
service: kamal-practice

# Name of the container image.
image: user/kamal-practice

# Deploy to these servers.
servers:
  - EC2IP
```

- registry
ä»Šå›ã¯docker hubã‚’ä½¿ã†ã®ã§dockerã®useråã‚’å…¥åŠ›ã—ã¾ã™
- env
å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’ã“ã“ã§å…¥åŠ›ã—ã¾ã™
- ssh
ubuntuã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦EC2ã‚’ä½œæˆã—ãŸå ´åˆ,ubuntuã‚’å…¥åŠ›ã—ã¾ã™

```ruby
# Credentials for your image host.
registry:
  # Specify the registry server, if you're not using Docker Hub
  # server: registry.digitalocean.com / ghcr.io / ...
  username: user

  # Always use an access token rather than real password when possible.
  password:
    - KAMAL_REGISTRY_PASSWORD

# Inject ENV variables into containers (secrets come from .env).
# Remember to run `kamal env push` after making changes!
env:
  secret:
    - RAILS_MASTER_KEY
    - DB_URL

# Use a different ssh user than root
ssh:
  user: ubuntu
```

:::details ç”Ÿæˆã•ã‚ŒãŸdeploy.yml
```ruby
# Name of your application. Used to uniquely configure containers.
service: my-app

# Name of the container image.
image: user/my-app

# Deploy to these servers.
servers:
  - 192.168.0.1

# Credentials for your image host.
registry:
  # Specify the registry server, if you're not using Docker Hub
  # server: registry.digitalocean.com / ghcr.io / ...
  username: my-user

  # Always use an access token rather than real password when possible.
  password:
    - KAMAL_REGISTRY_PASSWORD

# Inject ENV variables into containers (secrets come from .env).
# Remember to run `kamal env push` after making changes!
# env:
#   clear:
#     DB_HOST: 192.168.0.2
#   secret:
#     - RAILS_MASTER_KEY

# Use a different ssh user than root
# ssh:
#   user: app

# Configure builder setup.
# builder:
#   args:
#     RUBY_VERSION: 3.2.0
#   secrets:
#     - GITHUB_TOKEN
#   remote:
#     arch: amd64
#     host: ssh://app@192.168.0.1

# Use accessory services (secrets come from .env).
# accessories:
#   db:
#     image: mysql:8.0
#     host: 192.168.0.2
#     port: 3306
#     env:
#       clear:
#         MYSQL_ROOT_HOST: '%'
#       secret:
#         - MYSQL_ROOT_PASSWORD
#     files:
#       - config/mysql/production.cnf:/etc/mysql/my.cnf
#       - db/production.sql:/docker-entrypoint-initdb.d/setup.sql
#     directories:
#       - data:/var/lib/mysql
#   redis:
#     image: redis:7.0
#     host: 192.168.0.2
#     port: 6379
#     directories:
#       - data:/data

# Configure custom arguments for Traefik
# traefik:
#   args:
#     accesslog: true
#     accesslog.format: json

# Configure a custom healthcheck (default is /up on port 3000)
# healthcheck:
#   path: /healthz
#   port: 4000

# Bridge fingerprinted assets, like JS and CSS, between versions to avoid
# hitting 404 on in-flight requests. Combines all files from new and old
# version inside the asset_path.
# asset_path: /rails/public/assets

# Configure rolling deploys by setting a wait time between batches of restarts.
# boot:
#   limit: 10 # Can also specify as a percentage of total hosts, such as "25%"
#   wait: 2

```
:::

## kamal setup
ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã“ã¨ã§EC2ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã™
```ruby
kamal setup
```
ã“ã®ã‚³ãƒãƒ³ãƒ‰ãŒä¸€ä½“ãªã«ã‚’ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã‹ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™

>This will:
>1. Connect to the servers over SSH (using root by default, authenticated by your ssh key)
>2. Install Docker and curl on any server that might be missing it (using apt-get): root access is needed via ssh for this.
>3. Log into the registry both locally and remotely
>4. Build the image using the standard Dockerfile in the root of the application.
>5. Push the image to the registry.
>6. Pull the image from the registry onto the servers.
>7. Push the ENV variables from .env onto the servers.
>8. Ensure Traefik is running and accepting traffic on port 80.
>9. Ensure your app responds with 200 OK to GET /up (you must have curl installed inside your app image!).
>10. Start a new container with the version of the app that matches the current git version hash.
>11. Stop the old container running the previous version of the app.
>12. Prune unused images and stopped containers to ensure servers donâ€™t fill up.

ã„ã‚ã‚“ãªã‚¨ãƒ©ãƒ¼ã«é­é‡ã—ã¾ã—ãŸãŒ,ã‚µãƒ¼ãƒãƒ¼ã«sshã—ã¦å®Ÿéš›ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’docker runã—ã¦ã¿ãŸã‚Šã—ã¦
åŸå› ã‚’æ¢ã‚Šã¾ã—ãŸ
nginxã®docker imageã‚’ç”¨æ„ã—ãŸã»ã†ãŒã„ã„ã®ã‹ãª?ã¨æ€ã£ã¦ã„ãŸã®ã§ã™ãŒ
dockeråˆå¿ƒè€…ãªã®ã§traefikã®
kamalã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨,traefikã‚’åˆ©ç”¨ã—ã¦
pumaã¨traefikã®ç–é€šã‚‚è‡ªå‹•ã§è¡Œã£ã¦ãã‚Œã¾ã™
ã‚µãƒ¼ãƒãƒ¼ãŒport80ã‚’é–‹ã‘ãŸçŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™.
ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚„route53ã®è¨­å®šãƒŸã‚¹ã‚’ã—ã¦ã„ãŸã®ã«æ°—ä»˜ã‹ãš,
kamalã¯æœ¬å½“ã«pumaã®ãƒãƒ¼ãƒˆ3000ã¨traefikã®ãƒãƒ¼ãƒˆ80ã®ç–é€šã‚’è¡Œã£ã¦ãã‚Œã¦ã‚‹ã®ã‹...?
traefikã®è¨­å®šã‚’ã„ã‚ã„ã‚ã¨ã—ãªã„ã¨ã„ã‘ãªã„ã®ã§ã¯ãªã„ã‹,,,ã¨æ€ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç‰‡ã£ç«¯ã‹ã‚‰èª­ã¿æ¼ã£ãŸã‚Šã—ãŸã®ã§
1æ—¥ãã‚‰ã„ã¯è©°ã¾ã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒ
ç¬æ™‚ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã‚Œã¦ã¨ã¦ã‚‚ã§ã™ã­
awsã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒãƒãƒãƒã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆã—ãŸã‚Š,DBã‚’ä½œæˆã—ãŸã‚Šã™ã‚‹ã®ã¯è‹¥å¹²é¢å€’ãªã®ã§
terraformãªã©ã§è‡ªå‹•åŒ–ã—ãŸã‚Šã—ãŸã»ã†ãŒã„ã„ã‚ˆã†ãªãã‚‚ã—ã¾ã™

# ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã§æŒ¯ã‚Šåˆ†ã‘ã‚‹

- ã‚³ãƒãƒ³ãƒ‰ã®èª¬æ˜ã‚‚ã¡ã‚‡ã£ã¨ã™ã‚‹
-  config.assume_ssl = trueã‚’ç–é€šã•ã›ãªã„ã¨ã ã‚ã ã‚ˆ
- ãƒ­ã‚°ã‚’ã¿ã‚‹ã¨ã‚„ãŸã‚‰ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã¦é‚ªé­”ãã•ã„
- docker inspectã§dockerã®è¨­å®šãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹ã¿ã‚‹
```
  "Healthcheck": {
                "Test": [
                    "CMD-SHELL",
                    "(curl -f http://localhost:3000/up || exit 1) && (stat /tmp/kamal-cord/cord > /dev/null || exit 1)"
                ],
                "Interval": 1000000000
            },
```
ã“ã†ãªã£ã¦ã„ã‚‹
```
Ensure app can pass healthcheck...
  INFO [02be2305] Running docker run --detach --name healthcheck-kamal-practice-HEAD_uncommitted_1a96b4d1f65e791d --publish 3999:3000 --label service=healthcheck-kamal-practice -e KAMAL_CONTAINER_NAME="healthcheck-kamal-practice" --env-file .kamal/env/roles/kamal-practice-web.env --health-cmd "curl -f http://localhost:3000/up || exit 1" --health-interval "1s" onikukirai/kamal-practice:HEAD_uncommitted_1a96b4d1f65e791d on 35.78.76.96
```

ã“ã“ã§1sã”ã¨ã«healthcheckã™ã‚‹ã‚ˆã†ã«ã•ã‚Œã¦ã„ã‚‹
```
healthcheck:
  path: /healthz
  port: 4000
  max_attempts: 7
  interval: 20s
```
1æ™‚é–“ã¨ã‹ã«ã—ãŸã‹ã£ãŸã®ã ãŒ
```
Releasing the deploy lock...
  Finished all in 54.2 seconds
  ERROR (Kamal::Cli::Healthcheck::Poller::HealthcheckError): Exception while executing on host 13.230.17.150: container not ready (starting)
```
  healthcheckã®çµæœã‚’ã¾ã£ã¦ã„ã‚‹ã®ã§intervalã‚’é•·ãã—ã™ãã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¤±æ•—ã—ãŸã¨ã¿ãªã•ã‚Œã¦ã—ã¾ã†ã¿ãŸã„

  20sãŒæœ€å¤§ã§ã—ãŸ